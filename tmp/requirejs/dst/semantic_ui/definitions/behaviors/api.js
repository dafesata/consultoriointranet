/*!
 * # Semantic UI - API
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */

(function(e,t,n,r){var t=typeof t!="undefined"&&t.Math==Math?t:typeof self!="undefined"&&self.Math==Math?self:Function("return this")();e.api=e.fn.api=function(n){var i=e.isFunction(this)?e(t):e(this),s=i.selector||"",o=(new Date).getTime(),u=[],a=arguments[0],f=typeof a=="string",l=[].slice.call(arguments,1),c;return i.each(function(){var i=e.isPlainObject(n)?e.extend(!0,{},e.fn.api.settings,n):e.extend({},e.fn.api.settings),h=i.namespace,p=i.metadata,d=i.selector,v=i.error,m=i.className,g="."+h,y="module-"+h,b=e(this),w=b.closest(d.form),E=i.stateContext?e(i.stateContext):b,S,x,T,N,C,k=this,L=E[0],A=b.data(y),O;O={initialize:function(){f||O.bind.events(),O.instantiate()},instantiate:function(){O.verbose("Storing instance of module",O),A=O,b.data(y,A)},destroy:function(){O.verbose("Destroying previous module for",k),b.removeData(y).off(g)},bind:{events:function(){var e=O.get.event();e?(O.verbose("Attaching API events to element",e),b.on(e+g,O.event.trigger)):i.on=="now"&&(O.debug("Querying API endpoint immediately"),O.query())}},decode:{json:function(e){if(e!==r&&typeof e=="string")try{e=JSON.parse(e)}catch(t){}return e}},read:{cachedResponse:function(e){var n;if(t.Storage===r){O.error(v.noStorage);return}return n=sessionStorage.getItem(e),O.debug("Using cached response",e,n),n=O.decode.json(n),n}},write:{cachedResponse:function(n,i){if(i&&i===""){O.debug("Response empty, not caching",i);return}if(t.Storage===r){O.error(v.noStorage);return}e.isPlainObject(i)&&(i=JSON.stringify(i)),sessionStorage.setItem(n,i),O.verbose("Storing cached response for url",n,i)}},query:function(){if(O.is.disabled()){O.debug("Element is disabled API request aborted");return}if(O.is.loading()){if(!i.interruptRequests){O.debug("Cancelling request, previous request is still pending");return}O.debug("Interrupting previous request"),O.abort()}i.defaultData&&e.extend(!0,i.urlData,O.get.defaultData()),i.serializeForm&&(i.data=O.add.formData(i.data)),x=O.get.settings();if(x===!1){O.cancelled=!0,O.error(v.beforeSend);return}O.cancelled=!1,T=O.get.templatedURL();if(!T&&!O.is.mocked()){O.error(v.missingURL);return}T=O.add.urlData(T);if(!T&&!O.is.mocked())return;x.url=i.base+T,S=e.extend(!0,{},i,{type:i.method||i.type,data:N,url:i.base+T,beforeSend:i.beforeXHR,success:function(){},failure:function(){},complete:function(){}}),O.debug("Querying URL",S.url),O.verbose("Using AJAX settings",S);if(i.cache==="local"&&O.read.cachedResponse(T)){O.debug("Response returned from local cache"),O.request=O.create.request(),O.request.resolveWith(L,[O.read.cachedResponse(T)]);return}i.throttle?!i.throttleFirstRequest&&!O.timer?(O.debug("Sending request",N,S.method),O.send.request(),O.timer=setTimeout(function(){},i.throttle)):(O.debug("Throttling request",i.throttle),clearTimeout(O.timer),O.timer=setTimeout(function(){O.timer&&delete O.timer,O.debug("Sending throttled request",N,S.method),O.send.request()},i.throttle)):(O.debug("Sending request",N,S.method),O.send.request())},should:{removeError:function(){return i.hideError===!0||i.hideError==="auto"&&!O.is.form()}},is:{disabled:function(){return b.filter(d.disabled).length>0},expectingJSON:function(){return i.dataType==="json"||i.dataType==="jsonp"},form:function(){return b.is("form")||E.is("form")},mocked:function(){return i.mockResponse||i.mockResponseAsync||i.response||i.responseAsync},input:function(){return b.is("input")},loading:function(){return O.request?O.request.state()=="pending":!1},abortedRequest:function(e){return e&&e.readyState!==r&&e.readyState===0?(O.verbose("XHR request determined to be aborted"),!0):(O.verbose("XHR request was not aborted"),!1)},validResponse:function(t){return!O.is.expectingJSON()||!e.isFunction(i.successTest)?(O.verbose("Response is not JSON, skipping validation",i.successTest,t),!0):(O.debug("Checking JSON returned success",i.successTest,t),i.successTest(t)?(O.debug("Response passed success test",t),!0):(O.debug("Response failed success test",t),!1))}},was:{cancelled:function(){return O.cancelled||!1},succesful:function(){return O.request&&O.request.state()=="resolved"},failure:function(){return O.request&&O.request.state()=="rejected"},complete:function(){return O.request&&(O.request.state()=="resolved"||O.request.state()=="rejected")}},add:{urlData:function(t,n){var s,o;return t&&(s=t.match(i.regExp.required),o=t.match(i.regExp.optional),n=n||i.urlData,s&&(O.debug("Looking for required URL variables",s),e.each(s,function(s,o){var u=o.indexOf("$")!==-1?o.substr(2,o.length-3):o.substr(1,o.length-2),a=e.isPlainObject(n)&&n[u]!==r?n[u]:b.data(u)!==r?b.data(u):E.data(u)!==r?E.data(u):n[u];if(a===r)return O.error(v.requiredParameter,u,t),t=!1,!1;O.verbose("Found required variable",u,a),a=i.encodeParameters?O.get.urlEncodedValue(a):a,t=t.replace(o,a)})),o&&(O.debug("Looking for optional URL variables",s),e.each(o,function(i,s){var o=s.indexOf("$")!==-1?s.substr(3,s.length-4):s.substr(2,s.length-3),u=e.isPlainObject(n)&&n[o]!==r?n[o]:b.data(o)!==r?b.data(o):E.data(o)!==r?E.data(o):n[o];u!==r?(O.verbose("Optional variable Found",o,u),t=t.replace(s,u)):(O.verbose("Optional variable not found",o),t.indexOf("/"+s)!==-1?t=t.replace("/"+s,""):t=t.replace(s,""))}))),t},formData:function(t){var n=e.fn.serializeObject!==r,s=n?w.serializeObject():w.serialize(),o;return t=t||i.data,o=e.isPlainObject(t),o?n?(O.debug("Extending existing data with form data",t,s),t=e.extend(!0,{},t,s)):(O.error(v.missingSerialize),O.debug("Cant extend data. Replacing data with form data",t,s),t=s):(O.debug("Adding form data",s),t=s),t}},send:{request:function(){O.set.loading(),O.request=O.create.request(),O.is.mocked()?O.mockedXHR=O.create.mockedXHR():O.xhr=O.create.xhr(),i.onRequest.call(L,O.request,O.xhr)}},event:{trigger:function(e){O.query(),(e.type=="submit"||e.type=="click")&&e.preventDefault()},xhr:{always:function(){},done:function(t,n,r){var s=this,o=(new Date).getTime()-C,u=i.loadingDuration-o,a=e.isFunction(i.onResponse)?O.is.expectingJSON()?i.onResponse.call(s,e.extend(!0,{},t)):i.onResponse.call(s,t):!1;u=u>0?u:0,a&&(O.debug("Modified API response in onResponse callback",i.onResponse,a,t),t=a),u>0&&O.debug("Response completed early delaying state change by",u),setTimeout(function(){O.is.validResponse(t)?O.request.resolveWith(s,[t,r]):O.request.rejectWith(s,[r,"invalid"])},u)},fail:function(e,t,n){var r=this,s=(new Date).getTime()-C,o=i.loadingDuration-s;o=o>0?o:0,o>0&&O.debug("Response completed early delaying state change by",o),setTimeout(function(){O.is.abortedRequest(e)?O.request.rejectWith(r,[e,"aborted",n]):O.request.rejectWith(r,[e,"error",t,n])},o)}},request:{done:function(e,t){O.debug("Successful API Response",e),i.cache==="local"&&T&&(O.write.cachedResponse(T,e),O.debug("Saving server response locally",O.cache)),i.onSuccess.call(L,e,b,t)},complete:function(e,t){var n,r;O.was.succesful()?(r=e,n=t):(n=e,r=O.get.responseFromXHR(n)),O.remove.loading(),i.onComplete.call(L,r,b,n)},fail:function(e,t,n){var s=O.get.responseFromXHR(e),o=O.get.errorFromRequest(s,t,n);if(t=="aborted")return O.debug("XHR Aborted (Most likely caused by page navigation or CORS Policy)",t,n),i.onAbort.call(L,t,b,e),!0;t=="invalid"?O.debug("JSON did not pass success test. A server-side error has most likely occurred",s):t=="error"&&e!==r&&(O.debug("XHR produced a server error",t,n),e.status!=200&&n!==r&&n!==""&&O.error(v.statusMessage+n,S.url),i.onError.call(L,o,b,e)),i.errorDuration&&t!=="aborted"&&(O.debug("Adding error state"),O.set.error(),O.should.removeError()&&setTimeout(O.remove.error,i.errorDuration)),O.debug("API Request failed",o,e),i.onFailure.call(L,s,b,e)}}},create:{request:function(){return e.Deferred().always(O.event.request.complete).done(O.event.request.done).fail(O.event.request.fail)},mockedXHR:function(){var t=!1,n=!1,r=!1,s=i.mockResponse||i.response,o=i.mockResponseAsync||i.responseAsync,u,a,f;return f=e.Deferred().always(O.event.xhr.complete).done(O.event.xhr.done).fail(O.event.xhr.fail),s?(e.isFunction(s)?(O.debug("Using specified synchronous callback",s),a=s.call(L,x)):(O.debug("Using settings specified response",s),a=s),f.resolveWith(L,[a,t,{responseText:a}])):e.isFunction(o)&&(u=function(e){O.debug("Async callback returned response",e),e?f.resolveWith(L,[e,t,{responseText:e}]):f.rejectWith(L,[{responseText:e},n,r])},O.debug("Using specified async response callback",o),o.call(L,x,u)),f},xhr:function(){var t;return t=e.ajax(S).always(O.event.xhr.always).done(O.event.xhr.done).fail(O.event.xhr.fail),O.verbose("Created server request",t,S),t}},set:{error:function(){O.verbose("Adding error state to element",E),E.addClass(m.error)},loading:function(){O.verbose("Adding loading state to element",E),E.addClass(m.loading),C=(new Date).getTime()}},remove:{error:function(){O.verbose("Removing error state from element",E),E.removeClass(m.error)},loading:function(){O.verbose("Removing loading state from element",E),E.removeClass(m.loading)}},get:{responseFromXHR:function(t){return e.isPlainObject(t)?O.is.expectingJSON()?O.decode.json(t.responseText):t.responseText:!1},errorFromRequest:function(t,n,s){return e.isPlainObject(t)&&t.error!==r?t.error:i.error[n]!==r?i.error[n]:s},request:function(){return O.request||!1},xhr:function(){return O.xhr||!1},settings:function(){var t;return t=i.beforeSend.call(L,i),t&&(t.success!==r&&(O.debug("Legacy success callback detected",t),O.error(v.legacyParameters,t.success),t.onSuccess=t.success),t.failure!==r&&(O.debug("Legacy failure callback detected",t),O.error(v.legacyParameters,t.failure),t.onFailure=t.failure),t.complete!==r&&(O.debug("Legacy complete callback detected",t),O.error(v.legacyParameters,t.complete),t.onComplete=t.complete)),t===r&&O.error(v.noReturnedValue),t===!1?t:t!==r?e.extend(!0,{},t):e.extend(!0,{},i)},urlEncodedValue:function(e){var n=t.decodeURIComponent(e),r=t.encodeURIComponent(e),i=n!==e;return i?(O.debug("URL value is already encoded, avoiding double encoding",e),e):(O.verbose("Encoding value using encodeURIComponent",e,r),r)},defaultData:function(){var t={};return e.isWindow(k)||(O.is.input()?t.value=b.val():O.is.form()||(t.text=b.text())),t},event:function(){return e.isWindow(k)||i.on=="now"?(O.debug("API called without element, no events attached"),!1):i.on=="auto"?b.is("input")?k.oninput!==r?"input":k.onpropertychange!==r?"propertychange":"keyup":b.is("form")?"submit":"click":i.on},templatedURL:function(e){e=e||b.data(p.action)||i.action||!1,T=b.data(p.url)||i.url||!1;if(T)return O.debug("Using specified url",T),T;if(e){O.debug("Looking up url for action",e,i.api);if(i.api[e]===r&&!O.is.mocked()){O.error(v.missingAction,i.action,i.api);return}T=i.api[e]}else O.is.form()&&(T=b.attr("action")||E.attr("action")||!1,O.debug("No url or action specified, defaulting to form action",T));return T}},abort:function(){var e=O.get.xhr();e&&e.state()!=="resolved"&&(O.debug("Cancelling API request"),e.abort())},reset:function(){O.remove.error(),O.remove.loading()},setting:function(t,n){O.debug("Changing setting",t,n);if(e.isPlainObject(t))e.extend(!0,i,t);else{if(n===r)return i[t];e.isPlainObject(i[t])?e.extend(!0,i[t],n):i[t]=n}},internal:function(t,n){if(e.isPlainObject(t))e.extend(!0,O,t);else{if(n===r)return O[t];O[t]=n}},debug:function(){!i.silent&&i.debug&&(i.performance?O.performance.log(arguments):(O.debug=Function.prototype.bind.call(console.info,console,i.name+":"),O.debug.apply(console,arguments)))},verbose:function(){!i.silent&&i.verbose&&i.debug&&(i.performance?O.performance.log(arguments):(O.verbose=Function.prototype.bind.call(console.info,console,i.name+":"),O.verbose.apply(console,arguments)))},error:function(){i.silent||(O.error=Function.prototype.bind.call(console.error,console,i.name+":"),O.error.apply(console,arguments))},performance:{log:function(e){var t,n,r;i.performance&&(t=(new Date).getTime(),r=o||t,n=t-r,o=t,u.push({Name:e[0],Arguments:[].slice.call(e,1)||"","Execution Time":n})),clearTimeout(O.performance.timer),O.performance.timer=setTimeout(O.performance.display,500)},display:function(){var t=i.name+":",n=0;o=!1,clearTimeout(O.performance.timer),e.each(u,function(e,t){n+=t["Execution Time"]}),t+=" "+n+"ms",s&&(t+=" '"+s+"'"),(console.group!==r||console.table!==r)&&u.length>0&&(console.groupCollapsed(t),console.table?console.table(u):e.each(u,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),u=[]}},invoke:function(t,n,i){var s=A,o,u,a;return n=n||l,i=k||i,typeof t=="string"&&s!==r&&(t=t.split(/[\. ]/),o=t.length-1,e.each(t,function(n,i){var a=n!=o?i+t[n+1].charAt(0).toUpperCase()+t[n+1].slice(1):t;if(e.isPlainObject(s[a])&&n!=o)s=s[a];else{if(s[a]!==r)return u=s[a],!1;if(!e.isPlainObject(s[i])||n==o)return s[i]!==r?(u=s[i],!1):(O.error(v.method,t),!1);s=s[i]}})),e.isFunction(u)?a=u.apply(i,n):u!==r&&(a=u),e.isArray(c)?c.push(a):c!==r?c=[c,a]:a!==r&&(c=a),u}},f?(A===r&&O.initialize(),O.invoke(a)):(A!==r&&A.invoke("destroy"),O.initialize())}),c!==r?c:this},e.api.settings={name:"API",namespace:"api",debug:!1,verbose:!1,performance:!0,api:{},cache:!0,interruptRequests:!0,on:"auto",stateContext:!1,loadingDuration:0,hideError:"auto",errorDuration:2e3,encodeParameters:!0,action:!1,url:!1,base:"",urlData:{},defaultData:!0,serializeForm:!1,throttle:0,throttleFirstRequest:!0,method:"get",data:{},dataType:"json",mockResponse:!1,mockResponseAsync:!1,response:!1,responseAsync:!1,beforeSend:function(e){return e},beforeXHR:function(e){},onRequest:function(e,t){},onResponse:!1,onSuccess:function(e,t){},onComplete:function(e,t){},onFailure:function(e,t){},onError:function(e,t){},onAbort:function(e,t){},successTest:!1,error:{beforeSend:"The before send function has aborted the request",error:"There was an error with your request",exitConditions:"API Request Aborted. Exit conditions met",JSONParse:"JSON could not be parsed during error handling",legacyParameters:"You are using legacy API success callback names",method:"The method you called is not defined",missingAction:"API action used but no url was defined",missingSerialize:"jquery-serialize-object is required to add form data to an existing data object",missingURL:"No URL specified for api event",noReturnedValue:"The beforeSend callback must return a settings object, beforeSend ignored.",noStorage:"Caching responses locally requires session storage",parseError:"There was an error parsing your request",requiredParameter:"Missing a required URL parameter: ",statusMessage:"Server gave an error: ",timeout:"Your request timed out"},regExp:{required:/\{\$*[A-z0-9]+\}/g,optional:/\{\/\$*[A-z0-9]+\}/g},className:{loading:"loading",error:"error"},selector:{disabled:".disabled",form:"form"},metadata:{action:"action",url:"url"}}})(jQuery,window,document);